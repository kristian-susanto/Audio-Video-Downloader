<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi Downloader</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        text-align: center;
        background-color: #f0f2f5;
        padding-top: 50px;
      }
      .container {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        display: inline-block;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        width: 90%;
      }
      /* Tab Styling */
      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid #eee;
      }
      .tab-btn {
        flex: 1;
        padding: 12px;
        cursor: pointer;
        background: none;
        border: none;
        font-weight: bold;
        color: #666;
        transition: 0.3s;
      }
      .tab-btn.active {
        color: #cc0000;
        border-bottom: 2px solid #cc0000;
      }
      .tab-content {
        display: none;
        padding-top: 20px; /* Memberikan jarak antara info video dan tombol */
      }

      .tab-content.active {
        display: block;
      }

      input {
        width: 85%;
        padding: 12px;
        margin-bottom: 20px;
        border: 2px solid #eee;
        border-radius: 8px;
        outline: none;
      }
      input:focus {
        border-color: #cc0000;
      }

      #preview-container {
        margin-top: 20px;
        display: none;
      }
      img {
        width: 100%;
        border-radius: 12px;
        margin-bottom: 15px;
      }

      button.dl-btn {
        padding: 12px 25px;
        cursor: pointer;
        width: 100%;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 10px; /* Jarak tambahan di bawah tombol */
      }
      .btn-audio {
        background: #cc0000;
      }
      .btn-video {
        background: #007bff;
      }

      .loading {
        display: none;
        color: #666;
        margin-top: 15px;
        font-size: 14px;
      }

      /* Tambahkan ini agar judul panjang tetap terlihat rapi dan tidak terpotong */
      #media-content h3 {
        display: block;
        word-wrap: break-word; /* Memastikan kata panjang tidak keluar box */
        overflow: visible;
        height: auto;
        max-height: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 style="margin-top: 0">All-in-One Downloader</h1>

      <div class="tabs">
        <button
          class="tab-btn active"
          onclick="openTab(event, 'audio-section')"
        >
          ðŸŽµ Audio (MP3)
        </button>
        <button class="tab-btn" onclick="openTab(event, 'video-section')">
          ðŸŽ¥ Video (MP4)
        </button>
      </div>

      <input
        type="text"
        id="urlInput"
        placeholder="Tempel link video/post di sini..."
        oninput="handleUrlChange()"
      />

      <div id="preview-container">
        <div id="media-content"></div>

        <div id="audio-section" class="tab-content active">
          <form
            action="/download"
            method="post"
            onsubmit="showLoading('audio')"
          >
            <input type="hidden" name="url" class="formUrl" />
            <button type="submit" class="dl-btn btn-audio" id="btn-audio">
              Konversi ke MP3
            </button>
          </form>
        </div>

        <div id="video-section" class="tab-content">
          <form
            action="/download_video"
            method="post"
            onsubmit="showLoading('video')"
          >
            <input type="hidden" name="url" class="formUrl" />
            <button type="submit" class="dl-btn btn-video" id="btn-video">
              Download Video MP4
            </button>
          </form>
        </div>

        <div id="loadingMsg" class="loading"></div>
      </div>
    </div>

    <script>
      function openTab(evt, tabName) {
        const contents = document.getElementsByClassName("tab-content");
        for (let content of contents) content.classList.remove("active");

        const btns = document.getElementsByClassName("tab-btn");
        for (let btn of btns) btn.classList.remove("active");

        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
      }

      async function handleUrlChange() {
        const url = document.getElementById("urlInput").value.trim();
        const previewContainer = document.getElementById("preview-container");
        const mediaContent = document.getElementById("media-content");
        const formUrls = document.querySelectorAll(".formUrl");

        if (url.startsWith("http")) {
          previewContainer.style.display = "block";
          formUrls.forEach((input) => (input.value = url));
          mediaContent.innerHTML = "<p>Sedang mengambil preview...</p>";

          try {
            const response = await fetch("/get_info", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url: url }),
            });
            const data = await response.json();

            let secureThumbnail = data.thumbnail;
            if (data.platform === "instagram") {
              secureThumbnail = `https://images.weserv.nl/?url=${encodeURIComponent(data.thumbnail)}`;
            }

            // Tampilkan Caption/Judul dan Platform
            let displayTitle = data.title;

            // Jika platform adalah Instagram, gunakan description (caption)
            // Jika description kosong, baru gunakan title default
            if (data.platform === "instagram") {
              displayTitle =
                data.description && data.description.trim() !== ""
                  ? data.description
                  : "Instagram Post";

              // Opsional: Batasi panjang caption agar tidak terlalu panjang di preview
              if (displayTitle.length > 150) {
                displayTitle = displayTitle.substring(0, 147) + "...";
              }
            }

            mediaContent.innerHTML = `
              <img src="${secureThumbnail}" onerror="this.src='https://placehold.co/600x400?text=Preview+Tersedia'">
              <h3 style="font-size: 16px; margin: 5px 0 15px 0; padding: 0 15px; color: #333; line-height: 1.4; font-weight: 500;">${displayTitle}</h3>
              <div style="margin-bottom: 20px;"> <span style="font-size:12px; color:white; background:#666; padding:5px 15px; border-radius:20px; font-weight: bold;">
                  Platform: ${data.platform.charAt(0).toUpperCase() + data.platform.slice(1)}
                </span>
              </div>
            `;
          } catch (error) {
            mediaContent.innerHTML =
              "<p style='color:red;'>Gagal memuat preview.</p>";
          }
        } else {
          previewContainer.style.display = "none";
        }
      }

      function showLoading(type) {
        const btnId = type === "audio" ? "btn-audio" : "btn-video";
        const btn = document.getElementById(btnId);
        const loadingMsg = document.getElementById("loadingMsg");

        btn.disabled = true;
        btn.innerText = "Memproses...";
        btn.style.background = "#888";
        loadingMsg.style.display = "block";
        loadingMsg.innerHTML =
          "â™»ï¸ Sedang memproses file besar, mohon tunggu beberapa saat...";

        setTimeout(() => {
          btn.disabled = false;
          btn.innerText = "Selesai! Klik untuk download lagi";
          btn.style.background = "#28a745";
          setTimeout(() => {
            loadingMsg.style.display = "none";
            btn.innerText =
              type === "audio" ? "Konversi ke MP3" : "Download Video MP4";
            btn.style.background = "#cc0000";
          }, 5000);
        }, 12000);
      }
    </script>
  </body>
</html>
